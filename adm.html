<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADM | Nerees UFS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Outfit', sans-serif;
            background-color: #f8fafc;
            color: #1e293b;
        }

        .glass {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(226, 232, 240, 0.8);
        }

        .card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 1.5rem;
            transition: all 0.3s ease;
        }

        .card:hover {
            border-color: #3b82f6;
            box-shadow: 0 10px 25px -5px rgba(59, 130, 246, 0.1);
        }

        .btn-approve {
            background-color: #10b981;
            color: white;
        }

        .btn-reject {
            background-color: #ef4444;
            color: white;
        }

        .btn-delete {
            background-color: #64748b;
            color: white;
        }

        .sidebar-item-active {
            background-color: #eff6ff;
            color: #2563eb;
            border-right: 4px solid #2563eb;
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
    </style>
</head>

<body class="min-h-screen bg-slate-50 flex flex-col md:flex-row">

    <!-- Mobile Header -->
    <header class="md:hidden glass sticky top-0 z-50 px-6 py-4 flex items-center justify-between">
        <div class="flex items-center gap-2">
            <div class="bg-blue-600 p-2 rounded-xl text-white"><i data-lucide="shield-check" class="w-5 h-5"></i></div>
            <span class="font-bold text-lg">ADM Nerees</span>
        </div>
        <button id="mobile-menu-btn" class="p-2 bg-slate-100 rounded-lg"><i data-lucide="menu"
                class="w-6 h-6"></i></button>
    </header>

    <!-- Sidebar / Nav -->
    <aside id="sidebar" class="hidden md:flex flex-col w-full md:w-64 glass md:h-screen md:sticky md:top-0 z-40">
        <div class="p-6 hidden md:flex items-center gap-3 border-b border-slate-100">
            <div class="bg-blue-600 p-2 rounded-xl text-white shadow-lg"><i data-lucide="shield-check"
                    class="w-6 h-6"></i></div>
            <div>
                <h1 class="font-extrabold text-xl leading-none">Painel</h1>
                <p class="text-[10px] font-bold text-blue-600 uppercase tracking-widest mt-1">Nerees UFS</p>
            </div>
        </div>

        <nav class="p-4 space-y-2 flex-1">
            <button onclick="app.setView('dashboard')" id="nav-dashboard"
                class="w-full flex items-center gap-3 px-4 py-3 rounded-xl font-bold text-sm transition-all sidebar-item-active">
                <i data-lucide="layout-dashboard" class="w-5 h-5"></i> Dashboard
            </button>
            <button onclick="app.setView('requests')" id="nav-requests"
                class="w-full flex items-center gap-3 px-4 py-3 rounded-xl font-bold text-sm transition-all text-slate-500 hover:bg-slate-50">
                <i data-lucide="clipboard-list" class="w-5 h-5"></i> Pedidos <span id="pending-badge"
                    class="hidden ml-auto bg-amber-500 text-white text-[10px] px-2 py-0.5 rounded-full">0</span>
            </button>
            <button onclick="app.setView('equipment')" id="nav-equipment"
                class="w-full flex items-center gap-3 px-4 py-3 rounded-xl font-bold text-sm transition-all text-slate-500 hover:bg-slate-50">
                <i data-lucide="microscope" class="w-5 h-5"></i> Equipamentos
            </button>
            <button onclick="app.setView('agenda')" id="nav-agenda"
                class="w-full flex items-center gap-3 px-4 py-3 rounded-xl font-bold text-sm transition-all text-slate-500 hover:bg-slate-50">
                <i data-lucide="calendar" class="w-5 h-5"></i> Agenda
            </button>
        </nav>

        <div class="p-4 border-t border-slate-100">
            <div class="bg-slate-900 rounded-2xl p-4 text-white">
                <div class="flex items-center gap-2 mb-2">
                    <div id="status-dot-aside" class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></div>
                    <span class="text-[10px] font-bold uppercase" id="status-text-aside">Offline</span>
                </div>
                <p class="text-[9px] text-slate-400">Sistema Conectado via Firebase</p>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 p-6 md:p-10 max-w-6xl mx-auto w-full transition-all duration-500" id="main-content">
        <!-- Loader -->
        <div class="h-full flex flex-col items-center justify-center py-40">
            <div class="w-10 h-10 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
            <p class="mt-4 text-xs font-bold text-slate-400 tracking-widest uppercase">Carregando painel...</p>
        </div>
    </main>

    <!-- Notification Container -->
    <div id="notification-area" class="fixed top-6 right-6 z-[100] flex flex-col gap-2 pointer-events-none"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, updateDoc, deleteDoc, setDoc, query, orderBy, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBQlWoyujrlYisJjovxouVNwYvXmhR3FWw",
            authDomain: "cantinhodalimpeza-75a19.firebaseapp.com",
            projectId: "cantinhodalimpeza-75a19",
            storageBucket: "cantinhodalimpeza-75a19.firebasestorage.app",
            messagingSenderId: "173684695494",
            appId: "1:173684695494:web:2de21d48c8197b340512c7"
        };

        const app_fb = initializeApp(firebaseConfig);
        const auth = getAuth(app_fb);
        const db = getFirestore(app_fb);

        const commonAppId = "nerees_ufs_primary";

        window.app = {
            state: {
                view: 'dashboard',
                requests: [],
                equipmentList: [],
                user: null,
                isSidebarOpen: false,
                isManualAllocationOpen: false,
                manualAllocationForm: { name: '', org: '', equipment: '', date: '', startTime: '', endTime: '', requestId: null },
                isAllocationModalOpen: false,
                allocationForm: { id: null, name: '', equipment: '', date: '', startTime: '', endTime: '', phone: '' }
            },

            init() {
                this.setupMobileMenu();
                this.render();

                signInAnonymously(auth).catch(e => {
                    this.showNotification("Erro de autenticação", "error");
                    console.error(e);
                });

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        this.state.user = user;
                        this.updateStatus(true);
                        this.setupListeners();
                    } else {
                        this.updateStatus(false);
                    }
                });
            },

            setupMobileMenu() {
                const btn = document.getElementById('mobile-menu-btn');
                const sidebar = document.getElementById('sidebar');
                if (btn && sidebar) {
                    btn.onclick = () => {
                        sidebar.classList.toggle('hidden');
                        sidebar.classList.toggle('flex');
                    };
                }
            },

            updateStatus(online) {
                const dot = document.getElementById('status-dot-aside');
                const text = document.getElementById('status-text-aside');
                if (dot && text) {
                    dot.className = online ? "w-2 h-2 rounded-full bg-green-500 shadow-[0_0_10px_rgba(34,197,94,0.5)]" : "w-2 h-2 rounded-full bg-red-500 animate-pulse";
                    text.innerText = online ? "Conectado" : "Offline";
                }
            },

            setupListeners() {
                // Sincronizar pedidos
                const reqRef = collection(db, 'artifacts', commonAppId, 'public', 'data', 'requests');
                onSnapshot(reqRef, (s) => {
                    this.state.requests = s.docs.map(d => ({ id: d.id, ...d.data() }));
                    this.updateBadges();
                    this.render();
                });

                // Sincronizar Equipamentos
                const equipRef = doc(db, 'artifacts', commonAppId, 'public', 'data', 'settings', 'equipment');
                onSnapshot(equipRef, (s) => {
                    if (s.exists()) {
                        this.state.equipmentList = s.data().list || [];
                    } else {
                        // Inicializar lista se não existir
                        setDoc(equipRef, { list: ["HPLC - Agilent 1260 Infinity (CR.001)", "Espectrômetro FT-IR (SB.008)", "Outro / Não Listado"] });
                    }
                    this.render();
                });
            },

            updateBadges() {
                const pending = this.state.requests.filter(r => r.status === 'pending').length;
                const badge = document.getElementById('pending-badge');
                if (badge) {
                    badge.innerText = pending;
                    badge.classList.toggle('hidden', pending === 0);
                }
            },

            setView(viewName) {
                this.state.view = viewName;
                if (window.innerWidth < 768) document.getElementById('sidebar').classList.add('hidden');

                // Visual nav update
                ['dashboard', 'requests', 'equipment', 'agenda'].forEach(v => {
                    const btn = document.getElementById('nav-' + v);
                    if (btn) {
                        if (v === viewName) {
                            btn.className = "w-full flex items-center gap-3 px-4 py-3 rounded-xl font-bold text-sm transition-all sidebar-item-active";
                        } else {
                            btn.className = "w-full flex items-center gap-3 px-4 py-3 rounded-xl font-bold text-sm transition-all text-slate-500 hover:bg-slate-50";
                        }
                    }
                });
                this.render();
            },

            showNotification(msg, type = 'success') {
                const area = document.getElementById('notification-area');
                const notif = document.createElement('div');
                const bg = type === 'success' ? 'bg-slate-900' : 'bg-red-600';
                notif.className = `${bg} text-white px-5 py-4 rounded-2xl shadow-xl flex items-center gap-3 animate-slide-up pointer-events-auto min-w-[200px]`;
                notif.innerHTML = `<i data-lucide="${type === 'success' ? 'check' : 'alert-circle'}" class="w-5 h-5"></i><span class="text-sm font-bold">${msg}</span>`;
                area.appendChild(notif);
                lucide.createIcons();
                setTimeout(() => notif.remove(), 4000);
            },

            // --- AÇÕES ---
            async updateRequestStatus(id, status) {
                if (status === 'approved') {
                    const req = this.state.requests.find(r => r.id === id);
                    if (req) this.openAllocationModal(req);
                } else {
                    try {
                        const ref = doc(db, 'artifacts', commonAppId, 'public', 'data', 'requests', id);
                        await updateDoc(ref, { status });
                        this.showNotification(`Pedido Recusado`);
                    } catch (e) { this.showNotification("Erro ao atualizar", "error"); }
                }
            },

            openAllocationModal(req) {
                this.state.allocationForm = {
                    id: req.id,
                    name: req.name,
                    equipment: req.equipment,
                    date: req.date || new Date().toISOString().split('T')[0],
                    startTime: req.startTime || '08:00',
                    endTime: req.endTime || '12:00',
                    phone: req.phone || ''
                };
                this.state.isAllocationModalOpen = true;
                this.render();
            },

            closeAllocationModal() {
                this.state.isAllocationModalOpen = false;
                this.render();
            },

            async confirmAllocation() {
                const fd = this.state.allocationForm;
                if (!fd.date || !fd.startTime || !fd.endTime) return this.showNotification("Preencha data e horário", "error");

                try {
                    const ref = doc(db, 'artifacts', commonAppId, 'public', 'data', 'requests', fd.id);
                    await updateDoc(ref, {
                        status: 'approved',
                        date: fd.date,
                        startTime: fd.startTime,
                        endTime: fd.endTime
                    });
                    this.showNotification("Alocação Confirmada com Sucesso!");
                    this.closeAllocationModal();
                } catch (e) {
                    console.error(e);
                    this.showNotification("Erro ao confirmar", "error");
                }
            },

            findNextFreeSlot() {
                const fd = this.state.allocationForm;
                const approved = this.state.requests.filter(r => r.status === 'approved');
                let currentDate = new Date(fd.date);

                // Procurar nos próximos 60 dias
                for (let i = 0; i < 60; i++) {
                    const dateStr = currentDate.toISOString().split('T')[0];
                    const morningReserved = approved.find(r => r.date === dateStr && r.startTime === '08:00' && r.equipment === fd.equipment);
                    const afternoonReserved = approved.find(r => r.date === dateStr && r.startTime === '14:00' && r.equipment === fd.equipment);

                    if (!morningReserved) {
                        this.state.allocationForm.date = dateStr;
                        this.state.allocationForm.startTime = '08:00';
                        this.state.allocationForm.endTime = '12:00';
                        this.render();
                        return;
                    }
                    if (!afternoonReserved) {
                        this.state.allocationForm.date = dateStr;
                        this.state.allocationForm.startTime = '14:00';
                        this.state.allocationForm.endTime = '18:00';
                        this.render();
                        return;
                    }
                    currentDate.setDate(currentDate.getDate() + 1);
                }
                this.showNotification("Nenhum horário livre encontrado nos próximos 60 dias", "error");
            },

            async deleteRequest(id) {
                if (!confirm("Tem certeza que deseja excluir esta solicitação?")) return;
                try {
                    await deleteDoc(doc(db, 'artifacts', commonAppId, 'public', 'data', 'requests', id));
                    this.showNotification("Pedido removido");
                } catch (e) { this.showNotification("Erro ao excluir", "error"); }
            },

            openManualAllocation() {
                this.state.manualAllocationForm = {
                    name: '', org: 'Laboratório',
                    equipment: this.state.equipmentList[0] || '',
                    date: new Date().toISOString().split('T')[0],
                    startTime: '08:00', endTime: '12:00',
                    requestId: null
                };
                this.state.isManualAllocationOpen = true;
                this.render();
            },

            closeManualAllocation() {
                this.state.isManualAllocationOpen = false;
                this.render();
            },

            openManualAllocationWithData(date, start, end) {
                this.state.manualAllocationForm = {
                    name: '', org: 'Laboratório',
                    equipment: this.state.equipmentList[0] || '',
                    date, startTime: start, endTime: end,
                    requestId: null
                };
                this.state.isManualAllocationOpen = true;
                this.render();
            },

            async handleManualSubmit(e) {
                e.preventDefault();
                const fd = this.state.manualAllocationForm;
                if (!fd.name || !fd.equipment || !fd.date || !fd.startTime || !fd.endTime) {
                    return this.showNotification("Preencha os campos obrigatórios", "error");
                }

                const data = {
                    name: fd.name,
                    org: fd.org,
                    equipment: fd.equipment,
                    date: fd.date,
                    startTime: fd.startTime,
                    endTime: fd.endTime,
                    status: 'approved',
                    updatedAt: new Date().toISOString()
                };

                try {
                    if (fd.requestId) {
                        const ref = doc(db, 'artifacts', commonAppId, 'public', 'data', 'requests', fd.requestId);
                        await updateDoc(ref, data);
                        this.showNotification("Solicitação aprovada na nova data!");
                    } else {
                        await addDoc(collection(db, 'artifacts', commonAppId, 'public', 'data', 'requests'), {
                            ...data,
                            createdAt: new Date().toISOString(),
                            userId: 'admin_direct',
                            reason: 'Alocação Direta pelo Admin'
                        });
                        this.showNotification("Reserva criada com sucesso!");
                    }
                    this.closeManualAllocation();
                } catch (err) {
                    console.error(err);
                    this.showNotification("Erro ao processar reserva", "error");
                }
            },

            selectPendingRequest(req) {
                this.state.manualAllocationForm = {
                    ...this.state.manualAllocationForm,
                    name: req.name,
                    org: req.org || 'Laboratório',
                    equipment: req.equipment,
                    requestId: req.id
                };
                this.render();
            },

            handleManualInputChange(field, val) {
                this.state.manualAllocationForm[field] = val;
            },

            async addEquipment() {
                const name = prompt("Nome do novo equipamento:");
                if (!name) return;
                try {
                    const newList = [...this.state.equipmentList, name];
                    await setDoc(doc(db, 'artifacts', commonAppId, 'public', 'data', 'settings', 'equipment'), { list: newList });
                    this.showNotification("Equipamento adicionado");
                } catch (e) { this.showNotification("Erro ao adicionar", "error"); }
            },

            triggerCSVImport() {
                document.getElementById('csv-import-input').click();
            },

            triggerAgendaCSVImport() {
                document.getElementById('agenda-csv-input').click();
            },

            async importAgendaCSV(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async (event) => {
                    try {
                        const buffer = event.target.result;
                        const decode = (buf, encoding) => new TextDecoder(encoding).decode(buf);

                        let content = decode(buffer, 'utf-8');
                        // Se houver caracteres inválidos ou o conteúdo parecer errado, tenta Latin1 (comum em Excel no Brasil)
                        if (content.includes('\ufffd') || (!content.includes('Livre') && !content.includes('Reservado'))) {
                            content = decode(buffer, 'iso-8859-1');
                        }

                        const lines = content.split(/\r?\n/).map(l => l.trim()).filter(l => l !== '');
                        const allRows = lines.map(line => {
                            const sep = line.includes(';') ? ';' : ',';
                            return line.split(sep).map(c => c.trim().replace(/^"|"$/g, ''));
                        });

                        const requestsToAdd = [];
                        const seen = new Set();
                        const targetEquip = "Espectrômetro FT-IR (SB.008)";

                        const formatDate = (str) => {
                            if (!str) return null;
                            const m = str.match(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})/);
                            if (!m) return null;
                            const d = m[1].padStart(2, '0');
                            const mth = m[2].padStart(2, '0');
                            let y = m[3];
                            if (y.length === 2) y = '20' + y;
                            return `${y}-${mth}-${d}`;
                        };

                        for (let i = 0; i < allRows.length; i++) {
                            const row = allRows[i];
                            const dateCols = [];
                            row.forEach((cell, idx) => {
                                if (cell && cell.match(/^\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4}$/)) {
                                    const fmt = formatDate(cell);
                                    if (fmt) dateCols.push({ idx, date: fmt });
                                }
                            });

                            // Se encontrou uma linha com várias datas, é uma linha de cabeçalho de semana
                            if (dateCols.length >= 3) {
                                let morningRow = null;
                                let afternoonRow = null;

                                // Procura as linhas de Manhã e Tarde logo abaixo (limite de 4 linhas de distância)
                                for (let j = i + 1; j < Math.min(i + 5, allRows.length); j++) {
                                    const firstCell = allRows[j][0] || '';
                                    if (/Manh/i.test(firstCell)) morningRow = allRows[j];
                                    if (/Tard/i.test(firstCell)) afternoonRow = allRows[j];
                                }

                                const processRow = (dayRow, start, end) => {
                                    if (!dayRow) return;
                                    dateCols.forEach(dCol => {
                                        const status = dayRow[dCol.idx] || '';
                                        // Sua agenda tem dois blocos iguais lado a lado.
                                        // O segundo bloco (idx+6 se idx for de 1 a 5) costuma ter os nomes.
                                        const altNameIdx = dCol.idx <= 5 ? dCol.idx + 6 : dCol.idx;
                                        const altName = dayRow[altNameIdx] || '';

                                        const isLivre = /Livre/i.test(status) || status === '';
                                        const isIndisp = /Indisp/i.test(status) || /Feriado/i.test(status);

                                        // Se o status não for livre/indisp OU se houver um nome na coluna alternativa
                                        if ((!isLivre && !isIndisp) || (altName && altName.length > 2 && !/Livre|Indisp|Feriado/i.test(altName))) {
                                            const researcherName = (altName && altName.length > 2 && !/Livre|Indisp|Feriado/i.test(altName)) ? altName : status;

                                            const key = `${dCol.date}-${start}-${researcherName}`;
                                            if (!seen.has(key) && researcherName.length > 2) {
                                                requestsToAdd.push({
                                                    name: researcherName,
                                                    org: 'Laboratório (FTIR)',
                                                    equipment: targetEquip,
                                                    date: dCol.date,
                                                    startTime: start,
                                                    endTime: end,
                                                    status: 'approved',
                                                    createdAt: new Date().toISOString(),
                                                    userId: 'admin_agenda_csv',
                                                    reason: 'Importação Automática Agenda FTIR'
                                                });
                                                seen.add(key);
                                            }
                                        }
                                    });
                                };

                                processRow(morningRow, '08:00', '12:00');
                                processRow(afternoonRow, '14:00', '18:00');
                                i += 2; // Pula blocos processados
                            }
                        }

                        if (requestsToAdd.length > 0) {
                            this.showNotification(`Importando ${requestsToAdd.length} horários...`, "info");
                            for (const req of requestsToAdd) {
                                await addDoc(collection(db, 'artifacts', commonAppId, 'public', 'data', 'requests'), req);
                            }
                            this.showNotification(`${requestsToAdd.length} horários importados com sucesso!`, "success");
                            this.render(); // Forçar re-renderização
                        } else {
                            this.showNotification("Nenhum agendamento válido encontrado.", "error");
                        }
                    } catch (err) {
                        console.error("Erro na importação:", err);
                        this.showNotification("Falha no processamento do CSV.", "error");
                    }
                };
                reader.readAsArrayBuffer(file);
                e.target.value = '';
            },

            async importCSV(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async (event) => {
                    try {
                        const content = event.target.result;
                        const lines = content.split('\n');
                        const newList = [...this.state.equipmentList];
                        const countBefore = newList.length;

                        // Ignorar cabeçalho (TAG, Nome do equipamento, Marca, Modelo...)
                        for (let i = 1; i < lines.length; i++) {
                            const line = lines[i].trim();
                            if (!line) continue;

                            // Regex para lidar com vírgulas dentro de aspas
                            const parts = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                            if (parts.length >= 2) {
                                const tag = parts[0].replace(/"/g, '').trim();
                                const name = parts[1].replace(/"/g, '').trim();
                                const brand = parts[2] ? parts[2].replace(/"/g, '').trim() : '';
                                const model = parts[3] ? parts[3].replace(/"/g, '').trim() : '';

                                if (tag && name) {
                                    const fullName = `${name}${brand ? ' - ' + brand : ''}${model ? ' ' + model : ''} (${tag})`;
                                    if (!newList.includes(fullName)) {
                                        newList.push(fullName);
                                    }
                                }
                            }
                        }

                        if (newList.length > countBefore) {
                            await setDoc(doc(db, 'artifacts', commonAppId, 'public', 'data', 'settings', 'equipment'), { list: newList });
                            this.showNotification(`${newList.length - countBefore} equipamentos importados!`);
                        } else {
                            this.showNotification("Nenhum novo equipamento encontrado no CSV.");
                        }
                    } catch (err) {
                        console.error(err);
                        this.showNotification("Erro ao processar CSV", "error");
                    }
                };
                reader.readAsText(file, 'UTF-8');
                e.target.value = ''; // Reset
            },

            async removeEquipment(eq) {
                if (!confirm(`Remover "${eq}" da lista?`)) return;
                try {
                    const newList = this.state.equipmentList.filter(item => item !== eq);
                    await setDoc(doc(db, 'artifacts', commonAppId, 'public', 'data', 'settings', 'equipment'), { list: newList });
                    this.showNotification("Equipamento removido");
                } catch (e) { this.showNotification("Erro ao remover", "error"); }
            },

            // --- RENDERERS ---
            renderDashboard() {
                const pending = this.state.requests.filter(r => r.status === 'pending');
                const approved = this.state.requests.filter(r => r.status === 'approved');

                return `
                    <div class="space-y-8">
                        <div>
                            <h2 class="text-2xl font-extrabold tracking-tight">Painel de Controle</h2>
                            <p class="text-sm text-slate-500 font-medium">Resumo do sistema Nerees UFS</p>
                        </div>

                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
                            <div class="card p-6 border-l-4 border-l-amber-500">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-xs font-bold text-slate-400 uppercase tracking-widest">Aguardando</span>
                                    <div class="p-2 bg-amber-50 text-amber-600 rounded-lg"><i data-lucide="clock" class="w-4 h-4"></i></div>
                                </div>
                                <span class="text-3xl font-black">${pending.length}</span>
                            </div>
                            <div class="card p-6 border-l-4 border-l-emerald-500">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-xs font-bold text-slate-400 uppercase tracking-widest">Confirmados</span>
                                    <div class="p-2 bg-emerald-50 text-emerald-600 rounded-lg"><i data-lucide="check-circle" class="w-4 h-4"></i></div>
                                </div>
                                <span class="text-3xl font-black">${approved.length}</span>
                            </div>
                            <div class="card p-6 border-l-4 border-l-blue-500">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-xs font-bold text-slate-400 uppercase tracking-widest">Equipamentos</span>
                                    <div class="p-2 bg-blue-50 text-blue-600 rounded-lg"><i data-lucide="microscope" class="w-4 h-4"></i></div>
                                </div>
                                <span class="text-3xl font-black">${this.state.equipmentList.length}</span>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div class="space-y-4">
                                <h3 class="font-bold text-slate-800 flex items-center gap-2 px-2">
                                    <i data-lucide="alert-circle" class="w-4 h-4 text-amber-500"></i> Novos Pedidos
                                </h3>
                                <div class="space-y-3">
                                    ${pending.length === 0 ? '<p class="text-xs text-slate-400 p-4 font-medium">Tudo em dia!</p>' :
                        pending.slice(0, 3).map(r => `
                                        <div class="card p-4 flex items-center justify-between">
                                            <div>
                                                <h4 class="font-bold text-sm mb-1">${r.name}</h4>
                                                <p class="text-[10px] text-slate-500">${r.equipment} • ${r.date ? r.date.split('-').reverse().join('/') : 'S/D'}</p>
                                            </div>
                                            <button onclick="app.setView('requests')" class="p-2 hover:bg-slate-50 text-blue-600 transition-colors"><i data-lucide="arrow-right" class="w-4 h-4"></i></button>
                                        </div>
                                      `).join('')}
                                </div>
                            </div>

                            <div class="space-y-4">
                                <h3 class="font-bold text-slate-800 flex items-center gap-2 px-2">
                                    <i data-lucide="calendar" class="w-4 h-4 text-emerald-500"></i> Próximos na Agenda
                                </h3>
                                <div class="space-y-3">
                                    ${approved.length === 0 ? '<p class="text-xs text-slate-400 p-4 font-medium">Nenhum agendamento ativo.</p>' :
                        approved.sort((a, b) => a.date?.localeCompare(b.date)).slice(0, 3).map(r => `
                                        <div class="card p-4 border-l-2 border-l-emerald-100 flex items-center gap-3">
                                            <div class="w-10 h-10 rounded-xl bg-slate-50 flex items-center justify-center text-blue-600"><i data-lucide="calendar" class="w-5 h-5"></i></div>
                                            <div>
                                                <h4 class="font-bold text-sm mb-0.5">${r.equipment}</h4>
                                                <p class="text-[10px] text-slate-400">${r.date ? r.date.split('-').reverse().join('/') : 'S/D'} • ${r.startTime || ''}</p>
                                            </div>
                                        </div>
                                      `).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            },

            renderRequests() {
                const sorted = this.state.requests.sort((a, b) => b.createdAt.localeCompare(a.createdAt));

                return `
                    <div class="space-y-8">
                        <div class="flex items-center justify-between">
                            <div>
                                <h2 class="text-2xl font-extrabold tracking-tight">Gestão de Pedidos</h2>
                                <p class="text-sm text-slate-500 font-medium">Validar solicitações de reserva</p>
                            </div>
                            <div class="flex items-center gap-3">
                                <input type="file" id="agenda-csv-input" accept=".csv" class="hidden" onchange="app.importAgendaCSV(event)">
                                <button onclick="app.triggerAgendaCSVImport()" class="bg-white text-slate-700 border border-slate-200 px-5 py-3 rounded-2xl font-bold text-sm shadow-sm active:scale-95 transition-all flex items-center gap-2">
                                    <i data-lucide="calendar" class="w-4 h-4 text-emerald-600"></i> Importar Agenda CSV
                                </button>
                                <button onclick="app.openManualAllocation()" class="bg-blue-600 text-white px-5 py-3 rounded-2xl font-bold text-sm shadow-xl shadow-blue-200 active:scale-95 transition-all flex items-center gap-2">
                                    <i data-lucide="plus-circle" class="w-4 h-4"></i> Alocar Pessoa
                                </button>
                            </div>
                        </div>

                        <div class="overflow-hidden card">
                            <div class="overflow-x-auto">
                                <table class="w-full text-left border-collapse">
                                    <thead class="bg-slate-50/50 border-b border-slate-100">
                                        <tr>
                                            <th class="px-6 py-4 text-[10px] font-black uppercase text-slate-400 tracking-widest">Pesquisador</th>
                                            <th class="px-6 py-4 text-[10px] font-black uppercase text-slate-400 tracking-widest">Equipamento</th>
                                            <th class="px-6 py-4 text-[10px] font-black uppercase text-slate-400 tracking-widest">Data / Hora</th>
                                            <th class="px-6 py-4 text-[10px] font-black uppercase text-slate-400 tracking-widest text-center">Status</th>
                                            <th class="px-6 py-4 text-[10px] font-black uppercase text-slate-400 tracking-widest text-right">Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-50">
                                        ${sorted.length === 0 ? '<tr><td colspan="5" class="px-6 py-20 text-center text-slate-400 text-sm font-medium">Nenhuma solicitação encontrada</td></tr>' :
                        sorted.map(r => `
                                            <tr class="hover:bg-slate-50/30 transition-colors">
                                                <td class="px-6 py-4">
                                                    <div class="font-bold text-sm text-slate-900">${r.name}</div>
                                                    <div class="text-[10px] text-slate-400">${r.org || 'Laboratório'}</div>
                                                </td>
                                                <td class="px-6 py-4 text-sm font-medium text-slate-700">${r.equipment}</td>
                                                <td class="px-6 py-4 text-[11px] font-bold text-slate-500">
                                                    ${r.date ? r.date.split('-').reverse().join('/') : 'S/D'}<br>
                                                    <span class="text-[9px] text-slate-400">${r.startTime || ''} às ${r.endTime || ''}</span>
                                                </td>
                                                <td class="px-6 py-4 text-center">
                                                    <span class="px-2.5 py-1 rounded-full text-[10px] font-black uppercase tracking-wider ${r.status === 'approved' ? 'bg-emerald-100 text-emerald-700' :
                                r.status === 'rejected' ? 'bg-slate-100 text-slate-500' : 'bg-amber-100 text-amber-700'
                            }">${r.status === 'approved' ? 'Confirmado' : r.status === 'rejected' ? 'Cancelado' : 'Aguardando'}</span>
                                                </td>
                                                <td class="px-6 py-4 text-right">
                                                    <div class="flex items-center justify-end gap-2">
                                                        ${r.status === 'pending' ? `
                                                            <button onclick="app.updateRequestStatus('${r.id}', 'approved')" class="p-2 rounded-lg bg-emerald-500 text-white hover:bg-emerald-600 transition shadow-sm" title="Confirmar"><i data-lucide="check" class="w-4 h-4"></i></button>
                                                            <button onclick="app.updateRequestStatus('${r.id}', 'rejected')" class="p-2 rounded-lg bg-slate-400 text-white hover:bg-slate-500 transition shadow-sm" title="Cancelar"><i data-lucide="x" class="w-4 h-4"></i></button>
                                                        ` : `
                                                            ${r.phone ? `
                                                                <a href="https://wa.me/55${r.phone.replace(/\D/g, '')}?text=${encodeURIComponent(`Olá ${r.name}, seu agendamento para o equipamento ${r.equipment} no dia ${r.date ? r.date.split('-').reverse().join('/') : ''} (${r.startTime || ''} às ${r.endTime || ''}) foi CONFIRMADO.`)}" target="_blank" class="p-2 rounded-lg bg-emerald-100 text-emerald-600 hover:bg-emerald-200 transition shadow-sm" title="WhatsApp"><i data-lucide="message-circle" class="w-4 h-4"></i></a>
                                                            ` : ''}
                                                        `}
                                                        <button onclick="app.deleteRequest('${r.id}')" class="p-2 rounded-lg bg-slate-100 text-slate-300 hover:bg-red-50 hover:text-red-500 transition shadow-sm" title="Excluir"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                                    </div>
                                                </td>
                                            </tr>
                                          `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
            },

            renderEquipment() {
                return `
                    <div class="space-y-8">
                        <div class="flex items-center justify-between">
                            <div>
                                <h2 class="text-2xl font-extrabold tracking-tight">Equipamentos</h2>
                                <p class="text-sm text-slate-500 font-medium">Gerenciar lista disponível para os pesquisadores</p>
                            </div>
                            <div class="flex items-center gap-3">
                                <input type="file" id="csv-import-input" accept=".csv" class="hidden" onchange="app.importCSV(event)">
                                <button onclick="app.triggerCSVImport()" class="bg-white text-slate-700 border border-slate-200 px-5 py-3 rounded-2xl font-bold text-sm shadow-sm active:scale-95 transition-all flex items-center gap-2">
                                    <i data-lucide="upload-cloud" class="w-4 h-4 text-blue-600"></i> Importar CSV
                                </button>
                                <button onclick="app.addEquipment()" class="bg-blue-600 text-white px-5 py-3 rounded-2xl font-bold text-sm shadow-xl shadow-blue-200 active:scale-95 transition-all flex items-center gap-2">
                                    <i data-lucide="plus" class="w-4 h-4"></i> Novo
                                </button>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                            ${this.state.equipmentList.map(eq => `
                                <div class="card p-6 flex flex-col justify-between">
                                    <div class="flex items-start justify-between mb-4">
                                        <div class="p-3 bg-blue-50 text-blue-600 rounded-2xl"><i data-lucide="microscope" class="w-6 h-6"></i></div>
                                        <button onclick="app.removeEquipment('${eq}')" class="p-2 text-slate-300 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                    </div>
                                    <h3 class="font-extrabold text-slate-800 leading-tight">${eq}</h3>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            },

            renderAllocationModal() {
                if (!this.state.isAllocationModalOpen) return '';
                const fd = this.state.allocationForm;
                // Formatar telefone para WhatsApp (apenas números, assumindo +55 padrão se não houver)
                const phoneClean = fd.phone ? fd.phone.replace(/\D/g, '') : '';
                const waLink = phoneClean ? `https://wa.me/55${phoneClean}?text=${encodeURIComponent(`Olá ${fd.name}, seu agendamento para o equipamento ${fd.equipment} no dia ${fd.date ? fd.date.split('-').reverse().join('/') : ''} (${fd.startTime} às ${fd.endTime}) foi CONFIRMADO.`)}` : '#';

                return `
                    <div class="fixed inset-0 z-[110] flex items-center justify-center p-6 bg-slate-900/80 backdrop-blur-sm animate-fade-in">
                        <div class="bg-white w-full max-w-md rounded-[2rem] shadow-2xl overflow-hidden slide-up border border-slate-100">
                            <div class="bg-emerald-600 p-6 text-white relative overflow-hidden">
                                <div class="absolute -right-4 -top-4 w-24 h-24 bg-white/10 rounded-full blur-xl"></div>
                                <button onclick="app.closeAllocationModal()" class="absolute top-6 right-6 p-2 hover:bg-white/20 rounded-xl transition-all">
                                    <i data-lucide="x" class="w-5 h-5"></i>
                                </button>
                                <h2 class="text-xl font-black mb-1">Confirmar Alocação</h2>
                                <p class="text-emerald-100 text-xs font-bold uppercase tracking-widest">Definir Horário Final</p>
                            </div>

                            <div class="p-6 space-y-5 bg-white">
                                <div class="p-4 bg-slate-50 rounded-2xl border border-slate-100">
                                    <div class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Solicitante</div>
                                    <div class="font-bold text-slate-800">${fd.name}</div>
                                    <div class="text-xs text-slate-500 font-medium mt-0.5">${fd.equipment}</div>
                                </div>

                                <div class="space-y-1.5">
                                    <label class="text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1">Data da Reserva</label>
                                    <input type="date" class="w-full bg-slate-100 border-2 border-slate-200 p-4 rounded-2xl text-sm font-bold text-slate-900 focus:bg-white focus:border-emerald-500 transition-all outline-none" 
                                        value="${fd.date}" oninput="this.onchange()" onchange="app.state.allocationForm.date = this.value">
                                </div>

                                <div class="grid grid-cols-2 gap-4">
                                    <div class="space-y-1.5">
                                        <label class="text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1">Início</label>
                                        <input type="time" class="w-full bg-slate-100 border-2 border-slate-200 p-4 rounded-2xl text-sm font-bold text-slate-900 focus:bg-white focus:border-emerald-500 transition-all outline-none" 
                                            value="${fd.startTime}" onchange="app.state.allocationForm.startTime = this.value">
                                    </div>
                                    <div class="space-y-1.5">
                                        <label class="text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1">Fim</label>
                                        <input type="time" class="w-full bg-slate-100 border-2 border-slate-200 p-4 rounded-2xl text-sm font-bold text-slate-900 focus:bg-white focus:border-emerald-500 transition-all outline-none" 
                                            value="${fd.endTime}" onchange="app.state.allocationForm.endTime = this.value">
                                    </div>
                                </div>

                                <button onclick="app.findNextFreeSlot()" type="button" class="w-full bg-blue-50 text-blue-600 py-3 rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-blue-100 transition-all flex items-center justify-center gap-2">
                                    <i data-lucide="search" class="w-4 h-4"></i> Sugerir Próximo Dia Livre
                                </button>

                                <div class="pt-2 grid grid-cols-2 gap-3">
                                    ${phoneClean ? `
                                        <a href="${waLink}" target="_blank" class="flex items-center justify-center gap-2 bg-emerald-50 text-emerald-600 border border-emerald-100 py-4 rounded-2xl font-black text-[10px] uppercase tracking-widest hover:bg-emerald-100 active:scale-95 transition-all">
                                            <i data-lucide="message-circle" class="w-4 h-4"></i> WhatsApp
                                        </a>
                                    ` : `
                                        <button disabled class="flex items-center justify-center gap-2 bg-slate-50 text-slate-300 border border-slate-100 py-4 rounded-2xl font-black text-[10px] uppercase tracking-widest cursor-not-allowed">
                                            <i data-lucide="message-circle" class="w-4 h-4"></i> Sem contato
                                        </button>
                                    `}
                                    <button onclick="app.confirmAllocation()" class="col-span-1 bg-emerald-600 text-white py-4 rounded-2xl font-black text-[10px] uppercase tracking-widest shadow-xl shadow-emerald-500/20 active:scale-95 transition-all hover:bg-emerald-700">
                                        Confirmar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            },

            renderManualAllocationModal() {
                if (!this.state.isManualAllocationOpen) return '';
                const fd = this.state.manualAllocationForm;

                return `
                    <div class="fixed inset-0 z-[100] flex items-center justify-center p-6 bg-slate-900/60 backdrop-blur-md animate-fade-in">
                        <div class="bg-white w-full max-w-lg rounded-[2.5rem] shadow-2xl overflow-hidden slide-up border border-slate-100">
                            <div class="gradient-card p-8 text-white relative">
                                <button onclick="app.closeManualAllocation()" class="absolute top-6 right-6 p-2 hover:bg-white/20 rounded-xl transition-all">
                                    <i data-lucide="x" class="w-5 h-5"></i>
                                </button>
                                <h2 class="text-2xl font-black mb-1">Alocar Pessoa</h2>
                                <p class="text-blue-100 text-xs font-bold uppercase tracking-widest">Reserva Direta pelo Admin</p>
                            </div>

                            <div class="px-8 pt-8 pb-3 bg-slate-50/50">
                                <label class="text-[10px] font-black uppercase text-slate-500 tracking-widest ml-1 mb-3 block">Solicitações Pendentes (Atalho)</label>
                                <div class="flex gap-2 overflow-x-auto pb-4 scrollbar-hide">
                                    ${this.state.requests.filter(r => r.status === 'pending').length === 0 ?
                        '<span class="text-[10px] font-bold text-slate-400 italic bg-white px-4 py-3 rounded-2xl border border-slate-100 w-full text-center">Nenhuma pendência hoje</span>' :
                        this.state.requests.filter(r => r.status === 'pending').map(r => {
                            const isSelected = this.state.manualAllocationForm.requestId === r.id;
                            return `
                                                <button onclick="app.selectPendingRequest(${JSON.stringify(r).replace(/"/g, '&quot;')})" 
                                                    class="shrink-0 ${isSelected ? 'bg-blue-600 border-blue-600 shadow-xl shadow-blue-500/20' : 'bg-white border-slate-200 shadow-sm'} border px-4 py-3 rounded-2xl transition-all group active:scale-95 text-left">
                                                    <div class="text-[10px] font-black ${isSelected ? 'text-white' : 'text-slate-800 group-hover:text-blue-600'} uppercase leading-none truncate max-w-[100px]">${r.name.split(' ')[0]}</div>
                                                    <div class="text-[9px] font-bold ${isSelected ? 'text-blue-100' : 'text-slate-400 group-hover:text-blue-400'} mt-1.5 leading-none opacity-80">${r.equipment.split('-')[0].trim()}</div>
                                                </button>
                                            `;
                        }).join('')
                    }
                                </div>
                            </div>

                            <form onsubmit="app.handleManualSubmit(event)" class="p-8 space-y-6 bg-white">
                                <div class="space-y-1.5">
                                    <label class="text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1">Pesquisador / Usuário</label>
                                    <input required class="w-full bg-slate-100 border-2 border-slate-200 p-4 rounded-2xl text-sm font-bold text-slate-900 focus:bg-white focus:border-blue-500 transition-all outline-none placeholder:text-slate-400" 
                                        placeholder="Nome completo" value="${fd.name}" oninput="app.handleManualInputChange('name', this.value)">
                                </div>

                                <div class="space-y-1.5">
                                    <label class="text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1">Equipamento</label>
                                    <select required class="w-full bg-slate-100 border-2 border-slate-200 p-4 rounded-2xl text-sm font-bold text-slate-900 focus:bg-white focus:border-blue-500 transition-all outline-none"
                                        onchange="app.handleManualInputChange('equipment', this.value)">
                                        ${this.state.equipmentList.map(eq => `<option value="${eq}" ${fd.equipment === eq ? 'selected' : ''}>${eq}</option>`).join('')}
                                    </select>
                                </div>

                                <div class="grid grid-cols-1 gap-6">
                                    <div class="space-y-1.5">
                                        <label class="text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1">Data</label>
                                        <input required type="date" class="w-full bg-slate-100 border-2 border-slate-200 p-4 rounded-2xl text-sm font-bold text-slate-900 focus:bg-white focus:border-blue-500 transition-all outline-none" 
                                            value="${fd.date}" oninput="app.handleManualInputChange('date', this.value)">
                                    </div>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div class="space-y-1.5">
                                            <label class="text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1">Início</label>
                                            <input required type="time" class="w-full bg-slate-100 border-2 border-slate-200 p-4 rounded-2xl text-sm font-bold text-slate-900 focus:bg-white focus:border-blue-500 transition-all outline-none" 
                                                value="${fd.startTime}" oninput="app.handleManualInputChange('startTime', this.value)">
                                        </div>
                                        <div class="space-y-1.5">
                                            <label class="text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1">Fim</label>
                                            <input required type="time" class="w-full bg-slate-100 border-2 border-slate-200 p-4 rounded-2xl text-sm font-bold text-slate-900 focus:bg-white focus:border-blue-500 transition-all outline-none" 
                                                value="${fd.endTime}" oninput="app.handleManualInputChange('endTime', this.value)">
                                        </div>
                                    </div>
                                </div>

                                <div class="grid grid-cols-2 gap-4 pt-4">
                                    <button type="button" onclick="app.closeManualAllocation()" class="w-full bg-slate-200 text-slate-700 py-4 rounded-2xl font-black text-[10px] uppercase tracking-widest hover:bg-slate-300 active:scale-95 transition-all outline-none">
                                        Desistir
                                    </button>
                                    <button type="submit" class="w-full gradient-card text-white py-4 rounded-2xl font-black text-[10px] uppercase tracking-widest shadow-xl shadow-blue-500/20 active:scale-95 transition-all outline-none">
                                        Confirmar
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
            },

            renderAgenda() {
                const approved = this.state.requests.filter(r => r.status === 'approved');

                // Gerar datas (próximos 30 dias)
                const dates = [];
                const now = new Date();
                for (let i = 0; i < 30; i++) {
                    const d = new Date(now);
                    d.setDate(now.getDate() + i);
                    dates.push(d.toISOString().split('T')[0]);
                }

                // Garantir exibição de reservas fora dos 30 dias
                approved.forEach(r => {
                    if (r.date && !dates.includes(r.date)) dates.push(r.date);
                });
                dates.sort();

                const slots = [
                    { name: 'Manhã', start: '08:00', end: '12:00' },
                    { name: 'Tarde', start: '14:00', end: '18:00' }
                ];

                return `
                    <div class="space-y-8 animate-fade-in pb-20">
                        <div class="flex items-center justify-between">
                            <div>
                                <h2 class="text-2xl font-extrabold tracking-tight text-slate-900">Agenda de Disponibilidade</h2>
                                <p class="text-sm text-slate-500 font-medium">Grade completa (Livre / Reservado)</p>
                            </div>
                            <div class="flex gap-3">
                                <button onclick="app.triggerAgendaCSVImport()" class="bg-white text-emerald-600 border border-emerald-100 px-5 py-3 rounded-2xl font-bold text-sm shadow-sm active:scale-95 transition-all flex items-center gap-2">
                                    <i data-lucide="upload" class="w-4 h-4"></i> Importar Agenda
                                </button>
                                <button onclick="app.openManualAllocation()" class="bg-blue-600 text-white px-5 py-3 rounded-2xl font-bold text-sm shadow-xl shadow-blue-200 active:scale-95 transition-all flex items-center gap-2">
                                    <i data-lucide="plus" class="w-4 h-4"></i> Nova Reserva
                                </button>
                            </div>
                        </div>

                        <div class="space-y-12">
                            ${dates.map(date => {
                    const [y, m, d] = date.split('-');
                    const dateObj = new Date(y, m - 1, d);
                    const dayName = dateObj.toLocaleDateString('pt-BR', { weekday: 'long' });
                    const dayFormat = dateObj.toLocaleDateString('pt-BR', { day: 'numeric', month: 'long' });
                    const isWeekend = dateObj.getDay() === 0 || dateObj.getDay() === 6;

                    return `
                                    <div class="space-y-4">
                                        <div class="flex items-center gap-4 px-2">
                                            <div class="w-14 h-14 rounded-2xl bg-slate-900 text-white flex flex-col items-center justify-center">
                                                <span class="text-[9px] font-black leading-none opacity-50 uppercase">${dateObj.toLocaleDateString('pt-BR', { month: 'short' })}</span>
                                                <span class="text-2xl font-black leading-none mt-1">${d}</span>
                                            </div>
                                            <div>
                                                <h3 class="text-lg font-black text-slate-900 leading-none capitalize">${dayName}</h3>
                                                <span class="text-xs font-bold text-slate-400 capitalize">${dayFormat}</span>
                                            </div>
                                            ${isWeekend ? '<span class="ml-auto bg-slate-100 text-slate-500 text-[10px] font-black px-3 py-1 rounded-full uppercase tracking-widest">Fim de Semana</span>' : ''}
                                        </div>

                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            ${slots.map(slot => {
                        const reservation = approved.find(r => r.date === date &&
                            ((r.startTime && r.startTime.startsWith(slot.start.split(':')[0])) ||
                                (r.period && r.period.toLowerCase().includes(slot.name.toLowerCase())))
                        );

                        if (reservation) {
                            return `
                                                        <div class="bg-white border border-blue-100 p-5 rounded-3xl flex gap-4 items-center shadow-sm relative overflow-hidden">
                                                            <div class="absolute left-0 top-0 bottom-0 w-1.5 bg-blue-600"></div>
                                                            <div class="w-12 h-12 rounded-2xl bg-blue-50 text-blue-600 flex items-center justify-center shrink-0">
                                                                <i data-lucide="lock" class="w-5 h-5"></i>
                                                            </div>
                                                            <div class="flex-1 min-w-0">
                                                                <div class="flex items-center justify-between mb-1">
                                                                    <span class="text-[10px] font-black text-blue-600 uppercase tracking-widest">${slot.name}</span>
                                                                    <span class="bg-blue-600 text-white text-[9px] font-black px-2 py-0.5 rounded-full uppercase tracking-wider">Reservado</span>
                                                                </div>
                                                                <h4 class="font-black text-slate-800 text-sm truncate uppercase">${reservation.name}</h4>
                                                                <p class="text-[10px] text-slate-400 font-bold truncate">${reservation.equipment}</p>
                                                            </div>
                                                        </div>
                                                    `;
                        } else {
                            return `
                                                        <div onclick="app.openManualAllocationWithData('${date}', '${slot.start}', '${slot.end}')" 
                                                            class="bg-slate-50/50 border-2 border-dashed border-slate-200 p-5 rounded-3xl flex gap-4 items-center group hover:bg-white hover:border-emerald-500 hover:shadow-xl hover:shadow-emerald-500/10 transition-all cursor-pointer">
                                                            <div class="w-12 h-12 rounded-2xl bg-white text-slate-300 group-hover:bg-emerald-500 group-hover:text-white flex items-center justify-center shrink-0 transition-all shadow-sm">
                                                                <i data-lucide="plus" class="w-5 h-5"></i>
                                                            </div>
                                                            <div class="flex-1">
                                                                <div class="flex items-center justify-between">
                                                                    <span class="text-[10px] font-black text-slate-400 group-hover:text-emerald-600 uppercase tracking-widest transition-all">${slot.name}</span>
                                                                    <span class="text-[9px] font-black text-emerald-500 uppercase opacity-0 group-hover:opacity-100 transition-all">Disponível</span>
                                                                </div>
                                                                <h4 class="font-bold text-slate-400 group-hover:text-emerald-600 text-sm transition-all italic">Clique para reservar</h4>
                                                            </div>
                                                        </div>
                                                    `;
                        }
                    }).join('')}
                                        </div>
                                    </div>
                                `;
                }).join('')}
                        </div>
                    </div>
                `;
            },

            render() {
                const main = document.getElementById('main-content');
                if (!main) return;

                if (this.state.view === 'dashboard') main.innerHTML = this.renderDashboard();
                else if (this.state.view === 'requests') main.innerHTML = this.renderRequests();
                else if (this.state.view === 'equipment') main.innerHTML = this.renderEquipment();
                else if (this.state.view === 'agenda') main.innerHTML = this.renderAgenda();

                // Render Modal separate container if needed or just append to main/body
                let modalContainer = document.getElementById('modal-container');
                if (!modalContainer) {
                    modalContainer = document.createElement('div');
                    modalContainer.id = 'modal-container';
                    document.body.appendChild(modalContainer);
                }
                modalContainer.innerHTML = this.renderManualAllocationModal() + this.renderAllocationModal();

                lucide.createIcons();
            }
        };

        app.init();
    </script>
</body>

</html>